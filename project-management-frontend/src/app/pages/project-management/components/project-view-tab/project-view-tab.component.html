<mat-card class="overflow-hidden">
  <div class="overflow-x-auto">
    <table mat-table [dataSource]="(filteredData$ | async) || []" multiTemplateDataRows class="w-full">
      
      <!-- 展開按鈕欄 -->
      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef class="w-12"></th>
        <td mat-cell *matCellDef="let project" class="w-12">
          <button 
            mat-icon-button 
            (click)="onToggleRow(getRowKey(project))"
            class="text-gray-400">
            <mat-icon>{{ isRowExpanded(getRowKey(project)) ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- 系統名稱欄 -->
      <ng-container matColumnDef="system">
        <th mat-header-cell *matHeaderCellDef>系統名稱</th>
        <td mat-cell *matCellDef="let project">
          <div class="font-medium text-gray-900">{{ project.system }}</div>
        </td>
      </ng-container>

      <!-- 案件名稱欄 -->
      <ng-container matColumnDef="project">
        <th mat-header-cell *matHeaderCellDef>案件名稱</th>
        <td mat-cell *matCellDef="let project">
          <div class="font-medium text-gray-900">{{ project.project }}</div>
          <div class="text-xs text-gray-400 mt-1">
            {{ project.startDate }} ~ {{ project.expectedEndDate }}
          </div>
        </td>
      </ng-container>

      <!-- 案件進度欄 -->
      <ng-container matColumnDef="projectProgress">
        <th mat-header-cell *matHeaderCellDef>案件進度</th>
        <td mat-cell *matCellDef="let project">
          <mat-chip 
            [ngClass]="statusHelper.getStatusColor(project.status)"
            class="text-xs">
            {{ statusHelper.getStatusText(project.status) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- 總任務項欄 -->
      <ng-container matColumnDef="totalTasks">
        <th mat-header-cell *matHeaderCellDef>總任務項</th>
        <td mat-cell *matCellDef="let project" class="text-center">
          <span class="font-medium">{{ project.totalTasks }}</span>
        </td>
      </ng-container>

      <!-- 已完成欄 -->
      <ng-container matColumnDef="completed">
        <th mat-header-cell *matHeaderCellDef>已完成</th>
        <td mat-cell *matCellDef="let project" class="text-center">
          <span class="text-green-600 font-medium">{{ project.completedTasks }}</span>
        </td>
      </ng-container>

      <!-- 進行中欄 -->
      <ng-container matColumnDef="inProgress">
        <th mat-header-cell *matHeaderCellDef>進行中</th>
        <td mat-cell *matCellDef="let project" class="text-center">
          <span class="text-blue-600 font-medium">{{ project.inProgressTasks }}</span>
        </td>
      </ng-container>

      <!-- 未開始欄 -->
      <ng-container matColumnDef="notStarted">
        <th mat-header-cell *matHeaderCellDef>未開始</th>
        <td mat-cell *matCellDef="let project" class="text-center">
          <span class="text-gray-600 font-medium">{{ project.notStartedTasks }}</span>
        </td>
      </ng-container>

      <!-- 進度百分比欄 -->
      <ng-container matColumnDef="progressPercent">
        <th mat-header-cell *matHeaderCellDef>進度百分比</th>
        <td mat-cell *matCellDef="let project">
          <div class="flex items-center">
            <mat-progress-bar 
              mode="determinate" 
              [value]="project.overallProgress"
              [color]="project.overallProgress === 100 ? 'primary' : 'primary'"
              class="w-16 mr-2">
            </mat-progress-bar>
            <span class="text-sm text-gray-600">{{ project.overallProgress }}%</span>
          </div>
        </td>
      </ng-container>

      <!-- 操作欄 -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>操作</th>
        <td mat-cell *matCellDef="let project">
          <button mat-icon-button 
                  (click)="onAddTask(project.project); $event.stopPropagation()" 
                  class="text-green-600 hover:bg-green-50"
                  matTooltip="新增項目">
            <mat-icon class="text-sm">add_task</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- 展開的成員詳情欄 -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let project" [attr.colspan]="displayedColumnsWithExpand.length">
          <div class="expanded-detail-wrapper" 
               [class.expanded-detail-wrapper-expanded]="isRowExpanded(getRowKey(project))">
            <div class="expanded-detail">
              <div class="p-4 bg-green-25 border-l-4 border-green-200">
                <h4 class="font-medium text-gray-800 mb-3">專案成員與任務詳情</h4>
                <div class="space-y-4">
                  <div *ngFor="let member of project.membersList" class="border border-gray-200 rounded-lg p-3">
                    <div class="mb-2">
                      <h5 class="font-medium text-gray-700">{{ member.member }}</h5>
                    </div>
                    
                    <div class="space-y-2">
                      <div *ngFor="let task of member.tasks" 
                           class="grid grid-cols-1 md:grid-cols-7 gap-2 items-center p-2 bg-gray-50 rounded">
                        <!-- 姓名 -->
                        <div class="font-medium text-sm">{{ member.member }}</div>
                        
                        <!-- 項目名稱 -->
                        <div class="font-medium text-sm">{{ task.task }}</div>
                        
                        <!-- 項目狀態 -->
                        <mat-chip 
                          [ngClass]="statusHelper.getStatusColor(task.status)"
                          class="text-xs">
                          {{ statusHelper.getStatusText(task.status) }}
                        </mat-chip>
                        
                        <!-- 複雜度 -->
                        <mat-chip 
                          [ngClass]="statusHelper.getComplexityColor(task.complexity)"
                          class="text-xs">
                          {{ task.complexity }}
                        </mat-chip>
                        
                        <!-- 優先度 -->
                        <mat-chip 
                          [ngClass]="statusHelper.getPriorityColor(task.priority)"
                          class="text-xs">
                          {{ task.priority }}
                        </mat-chip>
                        
                        <!-- 開始日~預計完成日 -->
                        <div class="text-xs text-gray-600">
                          {{ task.startDate }} ~ {{ task.endDate }}
                        </div>
                        
                        <!-- 操作按鈕 -->
                        <div class="flex justify-end gap-1">
                          <button mat-icon-button 
                                  (click)="onEditTask(task)" 
                                  class="text-blue-600 hover:bg-blue-50"
                                  matTooltip="編輯項目">
                            <mat-icon class="text-xs">edit</mat-icon>
                          </button>
                          <button mat-icon-button 
                                  (click)="onDeleteTask(task)" 
                                  class="text-red-600 hover:bg-red-50"
                                  matTooltip="刪除項目">
                            <mat-icon class="text-xs">delete</mat-icon>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsWithExpand"></tr>
      <tr mat-row *matRowDef="let project; columns: displayedColumnsWithExpand;"
          class="hover:bg-gray-50 cursor-pointer element-row"
          [class.expanded-row]="isRowExpanded(getRowKey(project))"
          (click)="onToggleRow(getRowKey(project))"></tr>
      <tr mat-row *matRowDef="let project; columns: ['expandedDetail']" 
          class="detail-row"></tr>
    </table>
  </div>
</mat-card>