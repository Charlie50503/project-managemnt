<mat-card class="overflow-hidden">
  <!-- 新增項目按鈕 -->
  <div class="p-4 border-b border-gray-200">
    <button mat-raised-button color="primary" (click)="onAddTask()" class="flex items-center gap-2">
      <mat-icon>add</mat-icon>
      新增項目
    </button>
  </div>

  <div class="overflow-x-auto">
    <table mat-table [dataSource]="(filteredData$ | async) || []" multiTemplateDataRows class="w-full">

      <!-- 展開按鈕欄 -->
      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef class="w-12"></th>
        <td mat-cell *matCellDef="let group" class="w-12">
          <button mat-icon-button (click)="onToggleRow(getRowKey(group))" class="text-gray-400">
            <mat-icon>{{ isRowExpanded(getRowKey(group)) ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- 姓名欄 -->
      <ng-container matColumnDef="member">
        <th mat-header-cell *matHeaderCellDef>姓名</th>
        <td mat-cell *matCellDef="let group">
          <div class="font-medium text-gray-900">{{ group.member }}</div>
          <div class="text-xs text-gray-500 mt-1">{{ group.project }}</div>
        </td>
      </ng-container>

      <!-- 總任務項欄 -->
      <ng-container matColumnDef="totalTasks">
        <th mat-header-cell *matHeaderCellDef>總任務項</th>
        <td mat-cell *matCellDef="let group" class="text-center">
          <span class="font-medium">{{ group.tasks.length }}</span>
        </td>
      </ng-container>

      <!-- 已完成欄 -->
      <ng-container matColumnDef="completed">
        <th mat-header-cell *matHeaderCellDef>已完成</th>
        <td mat-cell *matCellDef="let group" class="text-center">
          <span class="text-green-600 font-medium">{{ getTaskStatusCount(group.tasks, 'completed') }}</span>
        </td>
      </ng-container>

      <!-- 進行中欄 -->
      <ng-container matColumnDef="inProgress">
        <th mat-header-cell *matHeaderCellDef>進行中</th>
        <td mat-cell *matCellDef="let group" class="text-center">
          <span class="text-blue-600 font-medium">{{ getTaskStatusCount(group.tasks, 'in-progress') }}</span>
        </td>
      </ng-container>

      <!-- 未開始欄 -->
      <ng-container matColumnDef="notStarted">
        <th mat-header-cell *matHeaderCellDef>未開始</th>
        <td mat-cell *matCellDef="let group" class="text-center">
          <span class="text-gray-600 font-medium">{{ getTaskStatusCount(group.tasks, 'not-started') }}</span>
        </td>
      </ng-container>

      <!-- 開始日~預計完成日欄 -->
      <ng-container matColumnDef="dateRange">
        <th mat-header-cell *matHeaderCellDef>開始日~預計完成日</th>
        <td mat-cell *matCellDef="let group">
          <div class="text-sm text-gray-600">
            {{ getDateRange(group.tasks) }}
          </div>
        </td>
      </ng-container>

      <!-- 展開的任務詳情欄 -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let group" [attr.colspan]="displayedColumnsWithExpand.length">
          <div class="expanded-detail-wrapper"
            [class.expanded-detail-wrapper-expanded]="isRowExpanded(getRowKey(group))">
            <div class="expanded-detail">
              <div class="p-4 bg-blue-25 border-l-4 border-blue-200">
                <h4 class="font-medium text-gray-800 mb-3">任務詳情</h4>
                <div class="space-y-3">
                  <div *ngFor="let task of group.tasks" class="border-b border-gray-200 pb-3 last:border-b-0">
                    <div class="grid grid-cols-1 md:grid-cols-7 gap-4 items-center">
                      <!-- 案件名稱 -->
                      <div class="font-medium text-gray-800">{{ task.project }}</div>

                      <!-- 系統名稱 -->
                      <div class="text-sm text-gray-600">{{ task.system }}</div>

                      <!-- 項目名稱 -->
                      <div class="font-medium text-gray-700">{{ task.task }}</div>

                      <!-- 項目狀態 -->
                      <mat-chip [ngClass]="statusHelper.getStatusColor(task.status)" class="text-xs">
                        {{ statusHelper.getStatusText(task.status) }}
                      </mat-chip>

                      <!-- 複雜度 -->
                      <mat-chip [ngClass]="statusHelper.getComplexityColor(task.complexity)" class="text-xs">
                        {{ task.complexity }}
                      </mat-chip>

                      <!-- 優先度 -->
                      <mat-chip [ngClass]="statusHelper.getPriorityColor(task.priority)" class="text-xs">
                        {{ task.priority }}
                      </mat-chip>

                      <!-- 開始日~預計完成日 -->
                      <div class="text-xs text-gray-600">
                        {{ task.startDate }} ~ {{ task.endDate }}
                      </div>

                      <!-- 操作按鈕 -->
                      <div class="flex justify-end gap-1">
                        <button mat-icon-button (click)="onCopyTask(task); $event.stopPropagation()"
                          class="text-green-600 hover:bg-green-50" matTooltip="複製項目">
                          <mat-icon class="text-sm">content_copy</mat-icon>
                        </button>
                        <button mat-icon-button (click)="onEditTask(task); $event.stopPropagation()"
                          class="text-blue-600 hover:bg-blue-50" matTooltip="編輯項目">
                          <mat-icon class="text-sm">edit</mat-icon>
                        </button>
                        <button mat-icon-button (click)="onDeleteTask(task); $event.stopPropagation()"
                          class="text-red-600 hover:bg-red-50" matTooltip="刪除項目">
                          <mat-icon class="text-sm">delete</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsWithExpand"></tr>
      <tr mat-row *matRowDef="let group; columns: displayedColumnsWithExpand;"
        class="hover:bg-gray-50 cursor-pointer element-row" [class.expanded-row]="isRowExpanded(getRowKey(group))"
        (click)="onToggleRow(getRowKey(group))"></tr>
      <tr mat-row *matRowDef="let group; columns: ['expandedDetail']" class="detail-row"></tr>
    </table>
  </div>
</mat-card>