<mat-card class="overflow-hidden">
  <div class="overflow-x-auto">
    <table mat-table [dataSource]="(filteredData$ | async) || []" multiTemplateDataRows class="w-full">
      
      <!-- å±•é–‹æŒ‰éˆ•æ¬„ -->
      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef class="w-12"></th>
        <td mat-cell *matCellDef="let group" class="w-12">
          <button 
            mat-icon-button 
            (click)="onToggleRow(getRowKey(group))"
            class="text-gray-400">
            <mat-icon>{{ isRowExpanded(getRowKey(group)) ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- æˆå“¡æ¬„ -->
      <ng-container matColumnDef="member">
        <th mat-header-cell *matHeaderCellDef>æˆå“¡</th>
        <td mat-cell *matCellDef="let group">
          <div class="font-medium text-gray-900">{{ group.member }}</div>
          <div class="text-sm text-gray-500">è² è·: {{ group.workload }}%</div>
        </td>
      </ng-container>

      <!-- å°ˆæ¡ˆ/ç³»çµ±æ¬„ -->
      <ng-container matColumnDef="project">
        <th mat-header-cell *matHeaderCellDef>å°ˆæ¡ˆ/ç³»çµ±</th>
        <td mat-cell *matCellDef="let group">
          <div class="font-medium text-gray-900">{{ group.project }}</div>
          <div class="text-sm text-gray-500">{{ group.system }}</div>
        </td>
      </ng-container>

      <!-- ä»»å‹™çµ±è¨ˆæ¬„ -->
      <ng-container matColumnDef="taskStats">
        <th mat-header-cell *matHeaderCellDef>ä»»å‹™çµ±è¨ˆ</th>
        <td mat-cell *matCellDef="let group" class="text-sm">
          <div>ç¸½ä»»å‹™: {{ group.tasks.length }} é …</div>
          <div class="text-green-600">å®Œæˆ: {{ getTaskStatusCount(group.tasks, 'completed') }}</div>
          <div class="text-blue-600">é€²è¡Œ: {{ getTaskStatusCount(group.tasks, 'in-progress') }}</div>
          <div class="text-gray-600">æœªé–‹å§‹: {{ getTaskStatusCount(group.tasks, 'not-started') }}</div>
        </td>
      </ng-container>

      <!-- æ•´é«”é€²åº¦æ¬„ -->
      <ng-container matColumnDef="progress">
        <th mat-header-cell *matHeaderCellDef>æ•´é«”é€²åº¦</th>
        <td mat-cell *matCellDef="let group">
          <div class="flex items-center">
            <mat-progress-bar 
              mode="determinate" 
              [value]="group.overallProgress"
              [color]="group.overallProgress === 100 ? 'primary' : (group.overallStatus === 'delayed' ? 'warn' : 'primary')"
              class="w-16 mr-2">
            </mat-progress-bar>
            <span class="text-sm text-gray-600">{{ group.overallProgress }}%</span>
          </div>
        </td>
      </ng-container>

      <!-- ç‹€æ…‹æ¬„ -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>ç‹€æ…‹</th>
        <td mat-cell *matCellDef="let group">
          <mat-chip 
            [ngClass]="statusHelper.getStatusColor(group.overallStatus)"
            class="text-xs">
            {{ statusHelper.getStatusText(group.overallStatus) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- æˆæœæ¬„ -->
      <ng-container matColumnDef="results">
        <th mat-header-cell *matHeaderCellDef>æˆæœ</th>
        <td mat-cell *matCellDef="let group">
          <div class="space-y-1">
            <div *ngIf="group.demos.length > 0" class="text-xs text-blue-600">
              ğŸ”— {{ group.demos.length }} å€‹Demo
            </div>
            <div *ngIf="group.screenshots > 0" class="text-xs text-gray-600">
              ğŸ“¸ {{ group.screenshots }} å€‹æˆªåœ–
            </div>
            <span *ngIf="group.demos.length === 0 && group.screenshots === 0" 
                  class="text-xs text-gray-400">ç„¡</span>
          </div>
        </td>
      </ng-container>

      <!-- å±•é–‹çš„ä»»å‹™è©³æƒ…æ¬„ -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let group" [attr.colspan]="displayedColumnsWithExpand.length">
          <div class="expanded-detail-wrapper" 
               [class.expanded-detail-wrapper-expanded]="isRowExpanded(getRowKey(group))">
            <div class="expanded-detail">
              <div class="p-4 bg-blue-25 border-l-4 border-blue-200">
                <div class="space-y-3">
                  <div *ngFor="let task of group.tasks" class="border-b border-gray-200 pb-3 last:border-b-0">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                      <div class="font-medium text-gray-800">{{ task.task }}</div>
                      
                      <div class="flex gap-2">
                        <mat-chip 
                          [ngClass]="statusHelper.getComplexityColor(task.complexity)"
                          class="text-xs">
                          è¤‡é›œåº¦: {{ task.complexity }}
                        </mat-chip>
                        <mat-chip 
                          [ngClass]="statusHelper.getPriorityColor(task.priority)"
                          class="text-xs">
                          å„ªå…ˆ: {{ task.priority }}
                        </mat-chip>
                      </div>
                      
                      <div class="text-xs text-gray-600">
                        {{ task.startDate }} ~ {{ task.endDate }}
                      </div>
                      
                      <mat-chip 
                        [ngClass]="statusHelper.getStatusColor(task.status)"
                        class="text-xs">
                        {{ statusHelper.getStatusText(task.status) }}
                      </mat-chip>
                      
                      <div class="text-xs text-gray-600">
                        <div *ngIf="task.actualEndDate" class="text-green-600">
                          å®Œæˆ: {{ task.actualEndDate }}
                        </div>
                      </div>
                      
                      <div class="text-xs">
                        <button mat-icon-button 
                                (click)="onEditTask(task)" 
                                class="text-blue-600 hover:bg-blue-50"
                                matTooltip="ç·¨è¼¯å·¥ä½œé …">
                          <mat-icon class="text-sm">edit</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsWithExpand"></tr>
      <tr mat-row *matRowDef="let group; columns: displayedColumnsWithExpand;"
          class="hover:bg-gray-50 cursor-pointer element-row"
          [class.expanded-row]="isRowExpanded(getRowKey(group))"
          (click)="onToggleRow(getRowKey(group))"></tr>
      <tr mat-row *matRowDef="let group; columns: ['expandedDetail']" 
          class="detail-row"></tr>
    </table>
  </div>
</mat-card>